<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒ¬ã‚·ãƒ”ãƒ¡ãƒ¢</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f9fafb;color:#333}
    header{background:#ff7043;color:#fff;text-align:center;padding:1.2rem 0;position:sticky;top:0;z-index:10}
    header h1{margin:0;font-size:1.4rem}
    header .version{font-size:0.8rem;opacity:0.9;margin-top:0.3rem}
    .popular-tags{display:flex;flex-wrap:wrap;justify-content:center;gap:0.4rem;margin-top:0.6rem}
    .popular-tag{background:rgba(255,255,255,0.25);color:#fff;padding:0.25rem 0.6rem;border-radius:999px;cursor:pointer}
    .controls{text-align:center;margin:1rem 0}
    input[type="text"],select{padding:0.45rem;border-radius:8px;border:1px solid #ccc;margin:0.4rem;font-size:1rem}
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:1rem;
      padding:1rem;
      max-width:1100px;
      margin:0 auto;
    }
    .recipe-card{
      background:#fff;
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 3px 8px rgba(0,0,0,0.08);
      position:relative;
      cursor:default;
      width:100%;
      box-sizing:border-box;
    }
    .recipe-card img{width:100%;height:130px;object-fit:cover;display:block}
    .recipe-info{padding:0.75rem}
    .recipe-title{font-weight:700;margin:0 0 0.5rem}
    .tags{display:flex;flex-wrap:wrap;gap:0.3rem}
    .tag{background:#eee;padding:0.2rem 0.5rem;border-radius:999px;font-size:0.8rem;cursor:pointer}
    .favorite-btn{position:absolute;top:8px;right:8px;background:rgba(255,255,255,0.9);border-radius:50%;padding:6px;cursor:pointer;font-size:16px;line-height:1;user-select:none}
    .favorite-btn[data-favorited="true"]{color:#ff4081}
    @media(max-width:600px){
      .recipe-card img{height:110px}
      .favorite-btn{top:6px;right:6px;font-size:14px;padding:5px}
    }

    /* ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«ï¼ˆè¡¨ç¤ºãŒä¸è¦ãªã‚‰ä¸‹éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§éè¡¨ç¤ºã«ã§ãã¾ã™ï¼‰ */
    #debugPanel {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 12px;
      z-index: 9999;
      max-width: 220px;
      box-sizing: border-box;
    }
    #debugPanel button { margin-left:6px; font-size:12px; padding:4px 6px; border-radius:6px; border:none; cursor:pointer; }
    #debugData { margin-top:6px; white-space:pre-wrap; font-size:11px; max-height:180px; overflow:auto; background:rgba(255,255,255,0.06); padding:6px; border-radius:6px; }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ³ ãƒ¬ã‚·ãƒ”ãƒ¡ãƒ¢</h1>
    <div class="version">ver: 2025-10-12c2 (favorites_v2_robust)</div>
    <div class="popular-tags" id="popularTags"></div>
  </header>

  <div class="controls">
    <input id="search" type="text" placeholder="ãƒ¬ã‚·ãƒ”åãƒ»ææ–™ã§æ¤œç´¢" />
    <select id="sort">
      <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
      <option value="popular">äººæ°—é †</option>
      <option value="recent">æœ€è¿‘è¦‹ãŸé †</option>
    </select>
  </div>

  <div class="grid" id="recipeGrid"></div>

  <!-- ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«ï¼ˆæ¤œè¨¼å¾Œã¯ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã”ã¨å‰Šé™¤ã—ã¦OKï¼‰ -->
  <div id="debugPanel" aria-hidden="false">
    <div>
      <strong>DEBUG favorites_v2</strong>
      <button id="dbgRefresh">æ›´æ–°</button>
      <button id="dbgClear" title="å®Œå…¨ã‚¯ãƒªã‚¢">ã‚¯ãƒªã‚¢</button>
    </div>
    <div id="debugData">{}</div>
  </div>

  <script>
  // =============================
  // è¨­å®š
  // =============================
  const RECIPES_JSON = "recipes.json";
  const recipeGrid = document.getElementById("recipeGrid");
  const searchInput = document.getElementById("search");
  const sortSelect = document.getElementById("sort");
  const popularTagsEl = document.getElementById("popularTags");

  let recipes = [];

  // =============================
  // Robust favorites_v2 implementation
  // - uses Object.create(null) to avoid prototype surprises
  // - validates and sanitizes stored data on load
  // =============================
  function createEmptyFavoritesObj() {
    return Object.create(null);
  }

  function loadFavoritesV2() {
    try {
      const raw = localStorage.getItem("favorites_v2");

      // early checks for common broken values (string "null", etc)
      if (!raw || raw === "null" || raw === "\"null\"" || raw === "undefined" || raw === "\"undefined\"") {
        // ensure clean state
        localStorage.removeItem("favorites_v2");
        return createEmptyFavoritesObj();
      }

      // parse
      const parsed = JSON.parse(raw);

      // must be plain object (not array, not null)
      if (!parsed || typeof parsed !== "object" || Array.isArray(parsed)) {
        localStorage.removeItem("favorites_v2");
        return createEmptyFavoritesObj();
      }

      // create proto-less object and copy only string keys
      const out = createEmptyFavoritesObj();
      Object.keys(parsed).forEach(k => {
        if (typeof k === "string" && (parsed[k] === true || parsed[k] === 1 || parsed[k] === "1")) {
          out[k] = true;
        } else if (typeof k === "string" && parsed[k]) {
          // if truthy non-boolean, still accept
          out[k] = true;
        }
      });
      return out;
    } catch (e) {
      console.warn("favorites_v2 load error:", e);
      localStorage.removeItem("favorites_v2");
      return createEmptyFavoritesObj();
    }
  }

  function saveFavoritesV2(obj) {
    try {
      // serialize plain object (no prototype)
      localStorage.setItem("favorites_v2", JSON.stringify(obj));
    } catch (e) {
      console.warn("favorites_v2 save error:", e);
    }
  }

  // initialize
  let favorites = loadFavoritesV2();

  // helper: strict own-property check
  function hasFavorite(name) {
    return Object.prototype.hasOwnProperty.call(favorites, name);
  }

  function toggleFavorite(name) {
    if (hasFavorite(name)) {
      delete favorites[name];
    } else {
      favorites[name] = true;
    }
    saveFavoritesV2(favorites);
    refreshDebugPanel();
    // only re-render ordering if default sort is selected (preserve user's selected sort)
    if (sortSelect.value === "default") renderRecipes();
    else renderRecipes(); // still re-render to update icons; keep simple
  }

  // =============================
  // tag / recent (unchanged)
  // =============================
  function loadTagUsage() {
    try {
      const raw = localStorage.getItem("tagUsage");
      const parsed = raw ? JSON.parse(raw) : {};
      return (parsed && typeof parsed === "object") ? parsed : {};
    } catch (e) {
      return {};
    }
  }
  let tagUsage = loadTagUsage();

  function saveTagUsage() {
    localStorage.setItem("tagUsage", JSON.stringify(tagUsage));
  }

  function loadRecentViews() {
    try {
      const raw = localStorage.getItem("recentViews");
      const parsed = raw ? JSON.parse(raw) : [];
      return Array.isArray(parsed) ? parsed : [];
    } catch (e) {
      return [];
    }
  }
  let recentViews = loadRecentViews();

  function saveRecentViews() {
    localStorage.setItem("recentViews", JSON.stringify(recentViews));
  }

  // =============================
  // JSON load and initial render
  // =============================
  fetch(RECIPES_JSON)
    .then(r => r.json())
    .then(data => {
      recipes = data;
      renderRecipes();
      renderPopularTags();
      refreshDebugPanel();
    })
    .catch(err => console.error("recipes.json èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err));

  // =============================
  // render
  // =============================
  function renderRecipes() {
    const q = (searchInput.value || "").trim().toLowerCase();
    let list = recipes.filter(r => {
      const nameOk = r.name && r.name.toLowerCase().includes(q);
      const tagOk = Array.isArray(r.tags) && r.tags.some(t => t.toLowerCase().includes(q));
      return q === "" ? true : (nameOk || tagOk);
    });

    const sortType = sortSelect.value;
    if (sortType === "recent") {
      list.sort((a,b) => (recentViews.indexOf(b.name) - recentViews.indexOf(a.name)));
    } else if (sortType === "popular") {
      list.sort((a,b) => ((b.clicks||0) - (a.clicks||0)));
    } else {
      list.sort((a,b) => {
        const fa = hasFavorite(a.name);
        const fb = hasFavorite(b.name);
        return fa === fb ? 0 : (fa ? -1 : 1);
      });
    }

    recipeGrid.innerHTML = "";
    list.forEach(r => {
      const card = document.createElement("div");
      card.className = "recipe-card";
      card.dataset.name = r.name;

      const favNow = hasFavorite(r.name);
      const favAttr = favNow ? 'data-favorited="true"' : 'data-favorited="false"';

      card.innerHTML = `
        <div class="favorite-btn" ${favAttr} data-name="${escapeHtml(r.name)}">â¤</div>
        <img src="${escapeAttr(r.image || '')}" alt="${escapeAttr(r.name)}">
        <div class="recipe-info">
          <div class="recipe-title">${escapeHtml(r.name)}</div>
          <div class="tags">${Array.isArray(r.tags) ? r.tags.map(t => `<span class="tag">${escapeHtml(t)}</span>`).join("") : ""}</div>
        </div>
      `;

      // events
      const imgEl = card.querySelector("img");
      imgEl.addEventListener("click", () => {
        window.open(r.url || "#", "_blank");
        r.clicks = (r.clicks || 0) + 1;
        recentViews = [r.name, ...recentViews.filter(n => n !== r.name)].slice(0,10);
        saveRecentViews();
      });

      const favBtn = card.querySelector(".favorite-btn");
      favBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        toggleFavorite(r.name);
        // update attribute immediately for visual feedback
        if (hasFavorite(r.name)) favBtn.setAttribute("data-favorited","true");
        else favBtn.setAttribute("data-favorited","false");
      });

      card.querySelectorAll(".tag").forEach(tagEl => {
        tagEl.addEventListener("click", (e) => {
          e.stopPropagation();
          const tagText = tagEl.textContent;
          searchInput.value = tagText;
          incrementTagUsage(tagText);
          saveTagUsage();
          renderPopularTags();
          renderRecipes();
        });
      });

      recipeGrid.appendChild(card);
    });
  }

  // =============================
  // tags
  // =============================
  function incrementTagUsage(tag) {
    tagUsage[tag] = (tagUsage[tag]||0) + 1;
  }

  function renderPopularTags() {
    const entries = Object.entries(tagUsage).sort((a,b)=>b[1]-a[1]).slice(0,8);
    popularTagsEl.innerHTML = entries.map(([tag]) => `<button class="popular-tag">${escapeHtml(tag)}</button>`).join("");
    popularTagsEl.querySelectorAll(".popular-tag").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const tag = btn.textContent;
        searchInput.value = tag;
        incrementTagUsage(tag);
        saveTagUsage();
        renderPopularTags();
        renderRecipes();
      });
    });
  }

  // =============================
  // UI helpers & events
  // =============================
  searchInput.addEventListener("input", () => renderRecipes());
  sortSelect.addEventListener("change", () => renderRecipes());

  function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
  function escapeAttr(s){ return escapeHtml(s||''); }

  // =============================
  // Debug panel functions
  // =============================
  const debugDataEl = document.getElementById("debugData");
  function refreshDebugPanel(){
    try {
      const raw = localStorage.getItem("favorites_v2");
      const pretty = raw ? JSON.stringify(JSON.parse(raw), null, 2) : "{}";
      debugDataEl.textContent = pretty;
    } catch(e) {
      debugDataEl.textContent = String(localStorage.getItem("favorites_v2"));
    }
  }
  document.getElementById("dbgRefresh").addEventListener("click", ()=>{ refreshDebugPanel(); alert("refreshed"); });
  document.getElementById("dbgClear").addEventListener("click", ()=>{
    localStorage.removeItem("favorites_v2");
    favorites = createEmptyFavoritesObj();
    saveFavoritesV2(favorites);
    refreshDebugPanel();
    renderRecipes();
    alert("favorites_v2 cleared");
  });

  // auto-refresh initially
  refreshDebugPanel();

  </script>

  <!-- ğŸ§¹ å®Œå…¨ãƒªã‚»ãƒƒãƒˆ -->
  <button id="resetStorageBtn"
  style="position:fixed;bottom:20px;right:20px;z-index:999;background:#ff4081;color:#fff;border:none;border-radius:999px;padding:12px 16px;font-size:14px;box-shadow:0 2px 6px rgba(0,0,0,0.2);">
  ğŸ§¹ ãƒªã‚»ãƒƒãƒˆ
  </button>

  <script>
  document.getElementById("resetStorageBtn").addEventListener("click",()=>{
    localStorage.clear();
    alert("localStorageã‚’å®Œå…¨åˆæœŸåŒ–ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚");
    location.href = location.pathname + "?v=" + Date.now();
  });
  </script>

</body>
</html>
