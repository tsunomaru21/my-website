<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒ¬ã‚·ãƒ”ãƒ¡ãƒ¢</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f9fafb;color:#333}
    header{background:#ff7043;color:#fff;text-align:center;padding:1.2rem 0;position:sticky;top:0;z-index:10}
    header h1{margin:0;font-size:1.4rem}
    header .version{font-size:0.8rem;opacity:0.9;margin-top:0.3rem}
    .popular-tags{display:flex;flex-wrap:wrap;justify-content:center;gap:0.4rem;margin-top:0.6rem}
    .popular-tag{background:rgba(255,255,255,0.25);color:#fff;padding:0.25rem 0.6rem;border-radius:999px;cursor:pointer}
    .controls{text-align:center;margin:1rem 0}
    input[type="text"],select{padding:0.45rem;border-radius:8px;border:1px solid #ccc;margin:0.4rem;font-size:1rem}
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:1rem;
      padding:1rem;
      max-width:1100px;
      margin:0 auto;
    }
    .recipe-card{
      background:#fff;
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 3px 8px rgba(0,0,0,0.08);
      position:relative;
      width:100%;
      box-sizing:border-box;
    }
    .recipe-card img{width:100%;height:130px;object-fit:cover;display:block}
    .recipe-info{padding:0.75rem}
    .recipe-title{font-weight:700;margin:0 0 0.5rem}
    .tags{display:flex;flex-wrap:wrap;gap:0.3rem}
    .tag{background:#eee;padding:0.2rem 0.5rem;border-radius:999px;font-size:0.8rem;cursor:pointer}
    .favorite-btn{
      position:absolute;top:8px;right:8px;
      background:rgba(255,255,255,0.95);
      border-radius:50%;padding:6px;cursor:pointer;font-size:16px;line-height:1;user-select:none;
      transition:transform .12s;
    }
    .favorite-btn:active{transform:scale(.94)}
    .favorite-btn.favorited{color:#ff4081}
    @media(max-width:600px){
      .recipe-card img{height:110px}
      .favorite-btn{top:6px;right:6px;font-size:14px;padding:5px}
    }

    #resetStorageBtn{position:fixed;bottom:20px;right:20px;z-index:999;background:#ff4081;color:#fff;border:none;border-radius:999px;padding:12px 16px;font-size:14px;box-shadow:0 2px 6px rgba(0,0,0,0.2);}
  </style>
</head>
<body>
  <header>
    <h1>ğŸ³ ãƒ¬ã‚·ãƒ”ãƒ¡ãƒ¢</h1>
    <div class="version">ver: 2025-10-12-idbased</div>
    <div class="popular-tags" id="popularTags"></div>
  </header>

  <div class="controls">
    <input id="search" type="text" placeholder="ãƒ¬ã‚·ãƒ”åãƒ»ææ–™ã§æ¤œç´¢" />
    <select id="sort">
      <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
      <option value="popular">äººæ°—é †</option>
      <option value="recent">æœ€è¿‘è¦‹ãŸé †</option>
    </select>
  </div>

  <div class="grid" id="recipeGrid"></div>

  <script>
  const RECIPES_JSON = "recipes.json";
  const recipeGrid = document.getElementById("recipeGrid");
  const searchInput = document.getElementById("search");
  const sortSelect = document.getElementById("sort");
  const popularTagsEl = document.getElementById("popularTags");

  // ------------------------
  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  // ------------------------
  function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

  // ------------------------
  // LocalStorageãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  // ------------------------
  function safeGet(key, fallback){
    try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }catch(e){ return fallback; }
  }
  function safeSet(key, value){
    try{ localStorage.setItem(key, JSON.stringify(value)); }catch(e){}
  }

  // ------------------------
  // ã‚¿ã‚°ãƒ»é–²è¦§å±¥æ­´
  // ------------------------
  let tagUsage = safeGet("tagUsage", {});
  function saveTagUsage(){ safeSet("tagUsage", tagUsage); }

  let recentViewsById = safeGet("recentViews_v2_id", []);
  function saveRecentViewsById(){ safeSet("recentViews_v2_id", recentViewsById); }

  // ------------------------
  // ãŠæ°—ã«å…¥ã‚Š(IDãƒ™ãƒ¼ã‚¹)
  // ------------------------
  const FAVORITES_KEY = "favorites_v4_id";
  let favoritesById = safeGet(FAVORITES_KEY, {});

  function isFavoriteById(id){ return !!favoritesById[id]; }
  function toggleFavoriteById(id){
    if(!id) return;
    if(isFavoriteById(id)) delete favoritesById[id];
    else favoritesById[id] = true;
    safeSet(FAVORITES_KEY, favoritesById);
    renderRecipes();
  }

  // ------------------------
  // ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ—§ãƒ‡ãƒ¼ã‚¿æ•‘å‡ºï¼‰
  // ------------------------
  function loadLegacyFavorites(){
    const keys = ["favorites_v3","favorites_v2","favorites"];
    for(const k of keys){
      try{
        const raw = localStorage.getItem(k);
        if(!raw) continue;
        const parsed = JSON.parse(raw);
        if(typeof parsed === "object"){
          const names = Array.isArray(parsed) ? parsed : Object.keys(parsed);
          names.forEach(n => {
            const r = recipes.find(x => x.name === n);
            if(r && r.id) favoritesById[r.id] = true;
          });
        }
      }catch(e){}
    }
    safeSet(FAVORITES_KEY, favoritesById);
  }

  function migrateRecentViews(){
    try{
      const old = safeGet("recentViews", []);
      if(!old || !old.length) return;
      const mapped = [];
      old.forEach(n=>{
        const r = recipes.find(x => x.name === n);
        if(r && r.id && !mapped.includes(r.id)) mapped.push(r.id);
      });
      recentViewsById = mapped.slice(0,10);
      saveRecentViewsById();
    }catch(e){}
  }

  // ------------------------
  // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
  // ------------------------
  let recipes = [];

  fetch(RECIPES_JSON)
    .then(r=>r.json())
    .then(data=>{
      recipes = Array.isArray(data)?data:[];
      loadLegacyFavorites();
      migrateRecentViews();
      renderRecipes();
      renderPopularTags();
    })
    .catch(e=>console.error("recipes.json load error",e));

  // ------------------------
  // æç”»
  // ------------------------
  function renderRecipes(){
    favoritesById = safeGet(FAVORITES_KEY,{});
    const q = (searchInput.value||"").trim().toLowerCase();

    let list = recipes.filter(r=>{
      const nOk = r.name && r.name.toLowerCase().includes(q);
      const tOk = Array.isArray(r.tags) && r.tags.some(t=>t.toLowerCase().includes(q));
      return q==="" ? true : (nOk||tOk);
    });

    const sortType = sortSelect.value;
    if(sortType==="recent"){
      list.sort((a,b)=>recentViewsById.indexOf(b.id)-recentViewsById.indexOf(a.id));
    }else if(sortType==="popular"){
      list.sort((a,b)=>(b.clicks||0)-(a.clicks||0));
    }else{
      list.sort((a,b)=>{
        const fa=isFavoriteById(a.id), fb=isFavoriteById(b.id);
        return fa===fb?0:(fa?-1:1);
      });
    }

    recipeGrid.innerHTML="";
    list.forEach(r=>{
      const card=document.createElement("div");
      card.className="recipe-card";

      const favBtn=document.createElement("button");
      favBtn.type="button";
      favBtn.className="favorite-btn";
      favBtn.textContent=isFavoriteById(r.id)?"â¤":"â™¡";
      if(isFavoriteById(r.id)) favBtn.classList.add("favorited");

      const favHandler=(e)=>{
        e.stopPropagation(); e.preventDefault();
        toggleFavoriteById(r.id);
        favBtn.classList.toggle("favorited",isFavoriteById(r.id));
        favBtn.textContent=isFavoriteById(r.id)?"â¤":"â™¡";
      };
      favBtn.addEventListener("pointerdown",favHandler);
      favBtn.addEventListener("click",favHandler);

      const img=document.createElement("img");
      img.src=r.image||""; img.alt=r.name||"";
      img.addEventListener("click",()=>{
        if(r.url) window.open(r.url,"_blank");
        r.clicks=(r.clicks||0)+1;
        recentViewsById=[r.id,...recentViewsById.filter(x=>x!==r.id)].slice(0,10);
        saveRecentViewsById();
      });

      const info=document.createElement("div");
      info.className="recipe-info";
      const title=document.createElement("div");
      title.className="recipe-title";
      title.textContent=r.name||"";
      const tagsWrap=document.createElement("div");
      tagsWrap.className="tags";
      if(Array.isArray(r.tags)){
        r.tags.forEach(t=>{
          const span=document.createElement("span");
          span.className="tag"; span.textContent=t;
          span.addEventListener("click",(e)=>{
            e.stopPropagation();
            searchInput.value=t;
            tagUsage[t]=(tagUsage[t]||0)+1;
            saveTagUsage(); renderPopularTags(); renderRecipes();
          });
          tagsWrap.appendChild(span);
        });
      }
      info.appendChild(title);
      info.appendChild(tagsWrap);

      card.appendChild(favBtn);
      card.appendChild(img);
      card.appendChild(info);
      recipeGrid.appendChild(card);
    });
  }

  function renderPopularTags(){
    const entries=Object.entries(tagUsage).sort((a,b)=>b[1]-a[1]).slice(0,8);
    popularTagsEl.innerHTML=entries.map(([t])=>`<button class="popular-tag">${escapeHtml(t)}</button>`).join("");
    popularTagsEl.querySelectorAll(".popular-tag").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const tag=btn.textContent;
        searchInput.value=tag;
        tagUsage[tag]=(tagUsage[tag]||0)+1;
        saveTagUsage(); renderPopularTags(); renderRecipes();
      });
    });
  }

  searchInput.addEventListener("input",()=>renderRecipes());
  sortSelect.addEventListener("change",()=>renderRecipes());

  // ------------------------
  // ãƒªã‚»ãƒƒãƒˆ
  // ------------------------
  const resetBtn=document.createElement("button");
  resetBtn.id="resetStorageBtn";
  resetBtn.textContent="ğŸ§¹ ãƒªã‚»ãƒƒãƒˆ";
  resetBtn.addEventListener("click",()=>{
    ["favorites_v4_id","favorites_v3","favorites_v2","favorites","tagUsage","recentViews_v2_id","recentViews"].forEach(k=>{
      try{localStorage.removeItem(k);}catch(e){}
    });
    alert("localStorageã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚");
    location.reload();
  });
  document.body.appendChild(resetBtn);
  </script>
</body>
</html>
