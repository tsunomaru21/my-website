<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>„É¨„Ç∑„Éî„É°„É¢</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f9fafb;color:#333}
    header{background:#ff7043;color:#fff;text-align:center;padding:1.2rem 0;position:sticky;top:0;z-index:10}
    header h1{margin:0;font-size:1.4rem}
    header .version{font-size:0.8rem;opacity:0.9;margin-top:0.3rem}
    .popular-tags{display:flex;flex-wrap:wrap;justify-content:center;gap:0.4rem;margin-top:0.6rem}
    .popular-tag{background:rgba(255,255,255,0.25);color:#fff;padding:0.25rem 0.6rem;border-radius:999px;cursor:pointer}
    .controls{text-align:center;margin:1rem 0}
    input[type="text"],select{padding:0.45rem;border-radius:8px;border:1px solid #ccc;margin:0.4rem;font-size:1rem}
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:1rem;
      padding:1rem;
      max-width:1100px;
      margin:0 auto;
    }
    .recipe-card{
      background:#fff;
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 3px 8px rgba(0,0,0,0.08);
      position:relative;
      width:100%;
      box-sizing:border-box;
    }
    .recipe-card img{width:100%;height:130px;object-fit:cover;display:block}
    .recipe-info{padding:0.75rem}
    .recipe-title{font-weight:700;margin:0 0 0.5rem}
    .tags{display:flex;flex-wrap:wrap;gap:0.3rem}
    .tag{background:#eee;padding:0.2rem 0.5rem;border-radius:999px;font-size:0.8rem;cursor:pointer}
    .favorite-btn{
      position:absolute;top:8px;right:8px;
      background:rgba(255,255,255,0.95);
      border-radius:50%;padding:6px;cursor:pointer;font-size:16px;line-height:1;user-select:none;
      transition:transform .12s;
    }
    .favorite-btn:active{transform:scale(.94)}
    .favorite-btn.favorited{color:#ff4081}
    @media(max-width:600px){
      .recipe-card img{height:110px}
      .favorite-btn{top:6px;right:6px;font-size:14px;padding:5px}
    }

    /* small reset button */
    #resetStorageBtn{position:fixed;bottom:20px;right:20px;z-index:999;background:#ff4081;color:#fff;border:none;border-radius:999px;padding:12px 16px;font-size:14px;box-shadow:0 2px 6px rgba(0,0,0,0.2);}
  </style>
</head>
<body>
  <header>
    <h1>üç≥ „É¨„Ç∑„Éî„É°„É¢</h1>
    <div class="version">ver: 2025-10-12-final</div>
    <div class="popular-tags" id="popularTags"></div>
  </header>

  <div class="controls">
    <input id="search" type="text" placeholder="„É¨„Ç∑„ÉîÂêç„ÉªÊùêÊñô„ÅßÊ§úÁ¥¢" />
    <select id="sort">
      <option value="default">„Éá„Éï„Ç©„É´„Éà</option>
      <option value="popular">‰∫∫Ê∞óÈ†Ü</option>
      <option value="recent">ÊúÄËøëË¶ã„ÅüÈ†Ü</option>
    </select>
  </div>

  <div class="grid" id="recipeGrid"></div>

  <script>
  // ------------------------
  // Ë®≠ÂÆö
  // ------------------------
  const RECIPES_JSON = "recipes.json";
  const recipeGrid = document.getElementById("recipeGrid");
  const searchInput = document.getElementById("search");
  const sortSelect = document.getElementById("sort");
  const popularTagsEl = document.getElementById("popularTags");

  // ------------------------
  // HTML escape helpers
  // ------------------------
  function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
  function escapeAttr(s){ return escapeHtml(s||''); }

  // ------------------------
  // favorites_v3: robust implementation
  // - data saved under 'favorites_v3'
  // - load is defensive and migrates from older keys if possible
  // ------------------------
  function loadFavoritesRaw(key){
    try{
      const raw = localStorage.getItem(key);
      return raw === null ? null : raw;
    }catch(e){
      return null;
    }
  }

  function parsePotentialFavorites(raw){
    // Accept multiple legacy formats and return normalized object { name: true, ... }
    if(raw === null) return null;
    // If it's already the string "null" or "undefined", treat as null
    const rtrim = raw.trim?.();
    if(rtrim === "" || rtrim.toLowerCase() === "null" || rtrim.toLowerCase() === "undefined") return null;

    // Try JSON.parse safely
    try {
      const parsed = JSON.parse(raw);
      // If parsed is array => treat as list of names
      if(Array.isArray(parsed)){
        const out = Object.create(null);
        parsed.forEach(v => { if(typeof v === "string" && v.trim()) out[v] = true; });
        return out;
      }
      // If parsed is object => pick keys with true-like values
      if(parsed && typeof parsed === "object"){
        const out = Object.create(null);
        Object.keys(parsed).forEach(k=>{
          const v = parsed[k];
          // Accept boolean true, numeric 1, or string "true" (case-insensitive)
          if(v === true || v === 1 || (typeof v === "string" && v.toLowerCase()==="true")) out[k] = true;
        });
        return out;
      }
      // If parsed is string (e.g. JSON parsed a quoted string) -> treat as single name
      if(typeof parsed === "string" && parsed.trim()){
        const out = Object.create(null);
        out[parsed.trim()] = true;
        return out;
      }
    } catch(e){
      // Not JSON: could be a comma-separated list or a legacy format like '["a","b"]' malformed
      // Try basic heuristics: comma-separated names
      try {
        if(raw.indexOf(",") !== -1){
          const parts = raw.split(",").map(s=>s.trim()).filter(Boolean);
          if(parts.length){
            const out = Object.create(null);
            parts.forEach(p => out[p] = true);
            return out;
          }
        }
        // If raw looks like a single name (no JSON), accept it
        if(raw.length && raw.length < 200 && !raw.includes("{") && !raw.includes("[")){
          const out = Object.create(null);
          out[raw.trim()] = true;
          return out;
        }
      } catch(e2){}
    }
    // Fallback: cannot parse
    return null;
  }

  function loadFavoritesV3(){
    // 1) try new key
    let raw = loadFavoritesRaw("favorites_v3");
    let parsed = parsePotentialFavorites(raw);
    if(parsed) return parsed;

    // 2) try previous keys for migration (favorites_v2, favorites)
    raw = loadFavoritesRaw("favorites_v2");
    parsed = parsePotentialFavorites(raw);
    if(parsed) {
      // save migrated to v3
      try { localStorage.setItem("favorites_v3", JSON.stringify(parsed)); } catch(e){}
      return parsed;
    }

    raw = loadFavoritesRaw("favorites");
    parsed = parsePotentialFavorites(raw);
    if(parsed) {
      try { localStorage.setItem("favorites_v3", JSON.stringify(parsed)); } catch(e){}
      return parsed;
    }

    // 3) nothing usable -> empty object
    return Object.create(null);
  }

  function saveFavoritesV3(obj){
    try {
      localStorage.setItem("favorites_v3", JSON.stringify(obj));
    } catch(e){
      // ignore write errors
      console.warn("saveFavoritesV3 error", e);
    }
  }

  // initialize favorites
  let favorites = loadFavoritesV3();

  function isFavorite(name){
    return !!(favorites && Object.prototype.hasOwnProperty.call(favorites, name) && favorites[name] === true);
  }

  function toggleFavorite(name){
    // normalize name to string
    const key = String(name || "");
    if(isFavorite(key)){
      delete favorites[key];
    } else {
      favorites[key] = true;
    }
    saveFavoritesV3(favorites);
    // immediate UI update
    renderRecipes();
  }

  // ------------------------
  // tag and recent handling (same as before)
  // ------------------------
  function loadTagUsage(){ try{ const r = localStorage.getItem("tagUsage"); return r ? JSON.parse(r) : {}; } catch(e){ return {}; } }
  function saveTagUsage(){ try{ localStorage.setItem("tagUsage", JSON.stringify(tagUsage)); } catch(e){} }
  function loadRecentViews(){ try{ const r = localStorage.getItem("recentViews"); return r ? JSON.parse(r) : []; } catch(e){ return []; } }
  function saveRecentViews(){ try{ localStorage.setItem("recentViews", JSON.stringify(recentViews)); } catch(e){} }

  let tagUsage = loadTagUsage();
  let recentViews = loadRecentViews();

  // ------------------------
  // load recipes and render
  // ------------------------
  let recipes = [];

  fetch(RECIPES_JSON)
    .then(r => r.json())
    .then(data => {
      recipes = Array.isArray(data) ? data : [];
      renderRecipes();
      renderPopularTags();
    })
    .catch(err => console.error("recipes.json load error:", err));

  // ------------------------
  // rendering
  // ------------------------
  function renderRecipes(){
    // refresh favorites from storage on each render to avoid out-of-sync (defensive)
    favorites = loadFavoritesV3();

    const q = (searchInput.value || "").trim().toLowerCase();
    let list = recipes.filter(r => {
      const nameOk = r.name && r.name.toLowerCase().includes(q);
      const tagOk = Array.isArray(r.tags) && r.tags.some(t => t.toLowerCase().includes(q));
      return q === "" ? true : (nameOk || tagOk);
    });

    const sortType = sortSelect.value;
    if(sortType === "recent") {
      list.sort((a,b) => recentViews.indexOf(b.name) - recentViews.indexOf(a.name));
    } else if(sortType === "popular"){
      list.sort((a,b) => ( (b.clicks||0) - (a.clicks||0) ));
    } else {
      list.sort((a,b) => {
        const fa = isFavorite(a.name);
        const fb = isFavorite(b.name);
        return fa === fb ? 0 : (fa ? -1 : 1);
      });
    }

    recipeGrid.innerHTML = "";
    list.forEach(r => {
      const card = document.createElement("div");
      card.className = "recipe-card";

      // create elements (avoid inserting boolean attributes directly)
      const favBtn = document.createElement("button");
      favBtn.type = "button";
      favBtn.className = "favorite-btn";
      favBtn.textContent = "‚ù§";
      if(isFavorite(r.name)) favBtn.classList.add("favorited");
      favBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        toggleFavorite(r.name);
      });

      const img = document.createElement("img");
      img.src = r.image || "";
      img.alt = r.name || "";
      img.addEventListener("click", () => {
        // open detail in new tab (count click)
        if(r.url) window.open(r.url, "_blank");
        r.clicks = (r.clicks || 0) + 1;
        recentViews = [r.name, ...recentViews.filter(n => n !== r.name)].slice(0,10);
        saveRecentViews();
      });

      const info = document.createElement("div");
      info.className = "recipe-info";
      const title = document.createElement("div");
      title.className = "recipe-title";
      title.textContent = r.name || "";
      const tagsWrap = document.createElement("div");
      tagsWrap.className = "tags";
      if(Array.isArray(r.tags)){
        r.tags.forEach(t=>{
          const span = document.createElement("span");
          span.className = "tag";
          span.textContent = t;
          span.addEventListener("click", (e) => {
            e.stopPropagation();
            searchInput.value = t;
            tagUsage[t] = (tagUsage[t] || 0) + 1;
            saveTagUsage();
            renderPopularTags();
            renderRecipes();
          });
          tagsWrap.appendChild(span);
        });
      }

      info.appendChild(title);
      info.appendChild(tagsWrap);

      card.appendChild(favBtn);
      card.appendChild(img);
      card.appendChild(info);

      recipeGrid.appendChild(card);
    });
  }

  function renderPopularTags(){
    const entries = Object.entries(tagUsage).sort((a,b)=>b[1]-a[1]).slice(0,8);
    popularTagsEl.innerHTML = entries.map(([tag]) => `<button class="popular-tag">${escapeHtml(tag)}</button>`).join("");
    popularTagsEl.querySelectorAll(".popular-tag").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const tag = btn.textContent;
        searchInput.value = tag;
        tagUsage[tag] = (tagUsage[tag] || 0) + 1;
        saveTagUsage();
        renderPopularTags();
        renderRecipes();
      });
    });
  }

  // ------------------------
  // UI events
  // ------------------------
  searchInput.addEventListener("input", () => renderRecipes());
  sortSelect.addEventListener("change", () => renderRecipes());

  // ------------------------
  // Reset button (helpful for testing)
  // ------------------------
  const resetBtn = document.createElement("button");
  resetBtn.id = "resetStorageBtn";
  resetBtn.textContent = "üßπ „É™„Çª„ÉÉ„Éà";
  resetBtn.addEventListener("click", ()=>{
    try { localStorage.removeItem("favorites_v3"); localStorage.removeItem("favorites_v2"); localStorage.removeItem("favorites"); localStorage.removeItem("tagUsage"); localStorage.removeItem("recentViews"); } catch(e){}
    alert("localStorage „ÇíÂàùÊúüÂåñ„Åó„Åæ„Åó„Åü„ÄÇÂÜçË™≠„ÅøËæº„Åø„Åó„Åæ„Åô„ÄÇ");
    location.href = location.pathname + "?v=" + Date.now();
  });
  document.body.appendChild(resetBtn);

  </script>
</body>
</html>
