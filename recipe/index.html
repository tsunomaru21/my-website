<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒ¬ã‚·ãƒ”ãƒ¡ãƒ¢</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f9fafb;color:#333}
    header{background:#ff7043;color:#fff;text-align:center;padding:1.2rem 0;position:sticky;top:0;z-index:10}
    header h1{margin:0;font-size:1.4rem}
    .popular-tags{display:flex;flex-wrap:wrap;justify-content:center;gap:0.4rem;margin-top:0.6rem}
    .popular-tag{background:rgba(255,255,255,0.25);color:#fff;padding:0.25rem 0.6rem;border-radius:999px;cursor:pointer}
    .controls{text-align:center;margin:1rem 0}
    input[type="text"],select{padding:0.45rem;border-radius:8px;border:1px solid #ccc;margin:0.4rem;font-size:1rem}
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:1rem;
      padding:1rem;
      max-width:1100px;
      margin:0 auto;
    }
    .recipe-card{
      background:#fff;
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 3px 8px rgba(0,0,0,0.08);
      position:relative;
      cursor:default;
      width:100%;
      box-sizing:border-box;
    }
    .recipe-card img{width:100%;height:130px;object-fit:cover;display:block}
    .recipe-info{padding:0.75rem}
    .recipe-title{font-weight:700;margin:0 0 0.5rem}
    .tags{display:flex;flex-wrap:wrap;gap:0.3rem}
    .tag{background:#eee;padding:0.2rem 0.5rem;border-radius:999px;font-size:0.8rem;cursor:pointer}
    .favorite-btn{position:absolute;top:8px;right:8px;background:rgba(255,255,255,0.9);border-radius:50%;padding:6px;cursor:pointer;font-size:16px;line-height:1;user-select:none}
    .favorite-btn.favorited{color:#ff4081}
    @media(max-width:600px){
      .recipe-card img{height:110px}
      .favorite-btn{top:6px;right:6px;font-size:14px;padding:5px}
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ³ ãƒ¬ã‚·ãƒ”ãƒ¡ãƒ¢</h1>
    <div class="popular-tags" id="popularTags"></div>
  </header>

  <div class="controls">
    <input id="search" type="text" placeholder="ãƒ¬ã‚·ãƒ”åãƒ»ææ–™ã§æ¤œç´¢" />
    <select id="sort">
      <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
      <option value="popular">äººæ°—é †</option>
      <option value="recent">æœ€è¿‘è¦‹ãŸé †</option>
    </select>
  </div>

  <div class="grid" id="recipeGrid"></div>

  <script>
  // --- è¨­å®š ---
  const RECIPES_JSON = "recipes.json"; // JSONãƒ‘ã‚¹

  // --- DOM ---
  const recipeGrid = document.getElementById("recipeGrid");
  const searchInput = document.getElementById("search");
  const sortSelect = document.getElementById("sort");
  const popularTagsEl = document.getElementById("popularTags");

  // --- çŠ¶æ…‹ç®¡ç† ---
  let recipes = [];

  // --- localStorageå¯¾å¿œï¼ˆSetã§ã¯ãªãArrayã§å®‰å®šï¼‰ ---
  function loadFavorites() {
    try {
      const raw = localStorage.getItem("favorites");
      if (!raw || raw === "undefined" || raw === "null") return [];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    } catch (e) {
      console.warn("favoritesèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
      localStorage.removeItem("favorites");
      return [];
    }
  }
  let favorites = loadFavorites();

  function saveFavorites() {
    localStorage.setItem("favorites", JSON.stringify(favorites));
  }

  function loadTagUsage() {
    try {
      const raw = localStorage.getItem("tagUsage");
      const parsed = raw ? JSON.parse(raw) : {};
      return (parsed && typeof parsed === "object") ? parsed : {};
    } catch (e) {
      return {};
    }
  }
  let tagUsage = loadTagUsage();

  function loadRecentViews() {
    try {
      const raw = localStorage.getItem("recentViews");
      const parsed = raw ? JSON.parse(raw) : [];
      return Array.isArray(parsed) ? parsed : [];
    } catch (e) {
      return [];
    }
  }
  let recentViews = loadRecentViews();

  function saveTagUsage() {
    localStorage.setItem("tagUsage", JSON.stringify(tagUsage));
  }
  function saveRecentViews() {
    localStorage.setItem("recentViews", JSON.stringify(recentViews));
  }

  // --- JSONèª­ã¿è¾¼ã¿ ---
  fetch(RECIPES_JSON)
    .then(r => r.json())
    .then(data => { recipes = data; renderRecipes(); renderPopularTags(); })
    .catch(err => { console.error("recipes.json èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err); });

  // --- æç”» ---
  function renderRecipes() {
    const q = (searchInput.value || "").trim().toLowerCase();
    let list = recipes.filter(r => {
      const nameOk = r.name && r.name.toLowerCase().includes(q);
      const tagOk = Array.isArray(r.tags) && r.tags.some(t => t.toLowerCase().includes(q));
      return q === "" ? true : (nameOk || tagOk);
    });

    const sortType = sortSelect.value;
    if (sortType === "recent") {
      list.sort((a,b) => (recentViews.indexOf(b.name) - recentViews.indexOf(a.name)));
    } else if (sortType === "popular") {
      list.sort((a,b) => ((b.clicks||0) - (a.clicks||0)));
    } else {
      list.sort((a,b) => {
        const fa = favorites.includes(a.name);
        const fb = favorites.includes(b.name);
        return fa === fb ? 0 : (fa ? -1 : 1);
      });
    }

    recipeGrid.innerHTML = "";
    list.forEach(r => {
      const card = document.createElement("div");
      card.className = "recipe-card";
      card.dataset.name = r.name;

      const favClass = favorites.includes(r.name) ? "favorited" : "";
      card.innerHTML = `
        <div class="favorite-btn ${favClass}" data-name="${escapeHtml(r.name)}">â¤</div>
        <img src="${escapeAttr(r.image || '')}" alt="${escapeAttr(r.name)}">
        <div class="recipe-info">
          <div class="recipe-title">${escapeHtml(r.name)}</div>
          <div class="tags">${Array.isArray(r.tags) ? r.tags.map(t => `<span class="tag">${escapeHtml(t)}</span>`).join("") : ""}</div>
        </div>
      `;

      const img = card.querySelector("img");
      img.addEventListener("click", (e) => {
        window.open(r.url || "#", "_blank");
        r.clicks = (r.clicks || 0) + 1;
        recentViews = [r.name, ...recentViews.filter(n => n !== r.name)].slice(0,10);
        saveRecentViews();
      });

      const favBtn = card.querySelector(".favorite-btn");
      favBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const name = r.name;
        if (favorites.includes(name)) {
          favorites = favorites.filter(f => f !== name);
          favBtn.classList.remove("favorited");
        } else {
          favorites.push(name);
          favBtn.classList.add("favorited");
        }
        saveFavorites();
        if (sortSelect.value === "default") renderRecipes();
      });

      card.querySelectorAll(".tag").forEach(tagEl => {
        tagEl.addEventListener("click", (e) => {
          e.stopPropagation();
          const tagText = tagEl.textContent;
          searchInput.value = tagText;
          incrementTagUsage(tagText);
          saveTagUsage();
          renderPopularTags();
          renderRecipes();
        });
      });

      recipeGrid.appendChild(card);
    });
  }

  // --- ã‚¿ã‚°äººæ°—å‡¦ç† ---
  function incrementTagUsage(tag) {
    tagUsage[tag] = (tagUsage[tag]||0) + 1;
  }
  function renderPopularTags() {
    const entries = Object.entries(tagUsage).sort((a,b)=>b[1]-a[1]).slice(0,8);
    popularTagsEl.innerHTML = entries.map(([tag]) => `<button class="popular-tag">${escapeHtml(tag)}</button>`).join("");
    popularTagsEl.querySelectorAll(".popular-tag").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        const tag = btn.textContent;
        searchInput.value = tag;
        incrementTagUsage(tag);
        saveTagUsage();
        renderPopularTags();
        renderRecipes();
      });
    });
  }

  // --- æ¤œç´¢ãƒ»ã‚½ãƒ¼ãƒˆã‚¤ãƒ™ãƒ³ãƒˆ ---
  searchInput.addEventListener("input", () => renderRecipes());
  sortSelect.addEventListener("change", () => renderRecipes());

  // --- HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ— ---
  function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
  function escapeAttr(s){ return escapeHtml(s||''); }

  // --- é–‹ç™ºç”¨ãƒªã‚»ãƒƒãƒˆ ---
  window.__resetRecipeStorage = function(){
    localStorage.removeItem("favorites");
    localStorage.removeItem("tagUsage");
    localStorage.removeItem("recentViews");
    location.reload();
  };
  </script>

  <button id="resetStorageBtn" style="position:fixed;bottom:20px;right:20px;z-index:999;background:#ff4081;color:#fff;border:none;border-radius:999px;padding:12px 16px;font-size:14px;box-shadow:0 2px 6px rgba(0,0,0,0.2);">
    ğŸ§¹ ãƒªã‚»ãƒƒãƒˆ
  </button>
  <script>
  document.getElementById("resetStorageBtn").addEventListener("click",()=>{
    localStorage.removeItem("favorites");
    localStorage.removeItem("tagUsage");
    localStorage.removeItem("recentViews");
    alert("localStorageã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚");
    location.reload();
  });
  </script>
</body>
</html>
