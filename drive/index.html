<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="description" content="お出かけ先一覧">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>お出かけ先一覧（カテゴリ＋履歴対応）</title>

  <style>
    :root {
      --accent: #4285F4;
      --muted: #666;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    #app {
      display: flex;
      height: 100%;
      width: 100%;
    }
    #sidebar {
      width: 320px;
      background: #fff;
      border-right: 1px solid #eee;
      padding: 12px;
      overflow: auto;
      display: none;
    }
    #map {
      flex: 1;
      height: 100%;
    }

    #bottomPanel {
      display: none;
      position: absolute;
      left: 12px;
      right: 12px;
      bottom: 12px;
      height: 260px;
      background: rgba(255,255,255,0.98);
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
    }
    #bottomPanel.minimized { transform: translateY(calc(100% - 40px)); }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
    }
    .btn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn.ghost {
      background: transparent;
      color: var(--accent);
      border: 1px solid rgba(66,133,244,0.3);
    }
    .filter-bar {
      display: flex;
      gap: 6px;
      overflow-x: auto;
      padding: 0 10px 10px 10px;
    }
    .filter-btn {
      padding: 6px 10px;
      border-radius: 8px;
      background: #f1f3f5;
      border: none;
      cursor: pointer;
      font-size: 13px;
      white-space: nowrap;
    }
    .filter-btn.active {
      background: var(--accent);
      color: #fff;
    }

    #list, #listMobile {
      overflow: auto;
      padding: 8px;
    }

    .list-item {
      display: flex;
      gap: 10px;
      align-items: center;
      border: 1px solid #eee;
      border-radius: 8px;
      margin-bottom: 8px;
      padding: 8px;
      cursor: pointer;
      background: #fff;
    }
    .list-item:hover { background: #f3f8ff; }
    .list-item img { width: 48px; height: 48px; object-fit: cover; border-radius: 6px; }
    .meta { flex: 1; }
    .meta h4 { margin: 0 0 4px 0; font-size: 15px; }
    .meta p { margin: 0; font-size: 13px; color: var(--muted); }
    .distance { font-weight: 600; color: var(--accent); font-size: 13px; white-space: nowrap; }

    @media (min-width: 900px) {
      #sidebar { display: block; }
      #bottomPanel { display: none; }
    }
    @media (max-width: 899px) {
      #sidebar { display: none; }
      #bottomPanel { display: flex; }
    }
  </style>
</head>

<body>
  <div id="app">
    <aside id="sidebar">
      <div class="toolbar">
        <h3>お出かけ先一覧</h3>
        <button id="locBtn" class="btn ghost">現在地</button>
      </div>
      <div class="filter-bar" id="filterBar"></div>
      <div id="list"></div>
    </aside>

    <div id="map"></div>

    <div id="bottomPanel">
      <div class="toolbar">
        <h3 style="margin:0;">お出かけ先</h3>
        <div style="display:flex; gap:6px;">
          <button id="locBtnMobile" class="btn ghost">現在地</button>
          <button id="togglePanel" class="btn">↕ 最小化</button>
        </div>
      </div>
      <div class="filter-bar" id="filterBarMobile"></div>
      <div id="listMobile"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@googlemaps/js-api-loader@1.16.6/dist/index.umd.min.js"></script>

  <script>
    const API_KEY = "AIzaSyAOt_zaWcDh2x8yNprbwL2qvnRjzOrPaq0";
    const DEFAULT_CENTER = { lat: 35.457, lng: 139.395 };

    const loader = new google.maps.plugins.loader.Loader({ apiKey: API_KEY, version: "weekly" });
    let map, infoWindow, userPos = null, allFeatures = [];

    const listEl = document.getElementById("list");
    const listMobileEl = document.getElementById("listMobile");
    const filterBar = document.getElementById("filterBar");
    const filterBarMobile = document.getElementById("filterBarMobile");
    const bottomPanel = document.getElementById("bottomPanel");
    const togglePanel = document.getElementById("togglePanel");
    const locBtn = document.getElementById("locBtn");
    const locBtnMobile = document.getElementById("locBtnMobile");

    togglePanel.addEventListener("click", () => bottomPanel.classList.toggle("minimized"));

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function formatDistance(m) {
      return m >= 1000 ? (m / 1000).toFixed(1) + " km" : Math.round(m) + " m";
    }

    function renderList(features) {
      const makeItem = (f, dist) => {
        const cat = f.getProperty("category");
        const img = `img/icon_${cat}.png`;
        const name = f.getProperty("name");
        const desc = f.getProperty("description") || "";
        const el = document.createElement("div");
        el.className = "list-item";
        el.innerHTML = `
          <img src="${img}" alt="${cat}">
          <div class="meta"><h4>${name}</h4><p>${desc}</p></div>
          <div class="distance">${formatDistance(dist)}</div>
        `;
        el.addEventListener("click", () => showInfo(f));
        return el;
      };

      listEl.innerHTML = "";
      listMobileEl.innerHTML = "";
      features.forEach(f => {
        const pos = f.getGeometry().get();
        const dist = userPos
          ? haversine(userPos.lat, userPos.lng, pos.lat(), pos.lng())
          : haversine(DEFAULT_CENTER.lat, DEFAULT_CENTER.lng, pos.lat(), pos.lng());
        const el = makeItem(f, dist);
        listEl.appendChild(el.cloneNode(true));
        listMobileEl.appendChild(el);
      });
    }

    function showInfo(f) {
      const pos = f.getGeometry().get();
      const html = `
        <img style="float:left; width:50px; margin:6px;" src="img/logo_${f.getProperty("category")}.png">
        <div style="margin-left:60px;">
          <h2 style="font-size:16px; margin:0;">${f.getProperty("name")}</h2>
          <p style="font-size:13px;">${f.getProperty("description")}</p>
          <a href="https://www.google.com/maps/dir/?api=1&destination=${f.getProperty("ido")},${f.getProperty("keido")}" target="_blank">
            Google Mapで開く
          </a>
        </div>`;
      infoWindow.setContent(html);
      infoWindow.setPosition(pos);
      infoWindow.open(map);
      updateHistory(f.getProperty("storeid"));
    }

    function renderFilters(categories) {
      const makeBtn = (name) => {
        const btn = document.createElement("button");
        btn.className = "filter-btn";
        btn.textContent = name;
        btn.dataset.cat = name;
        btn.addEventListener("click", () => applyFilter(name));
        return btn;
      };
      [filterBar, filterBarMobile].forEach(bar => {
        bar.innerHTML = "";
        ["すべて", ...categories].forEach(cat => bar.appendChild(makeBtn(cat)));
      });
      document.querySelectorAll(".filter-btn[data-cat='すべて']").forEach(btn => btn.classList.add("active"));
    }

    function applyFilter(cat) {
      document.querySelectorAll(".filter-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.cat === cat);
      });
      const filtered = cat === "すべて"
        ? allFeatures
        : allFeatures.filter(f => f.getProperty("category") === cat);
      renderList(orderByHistory(filtered));
      map.data.forEach(f => map.data.overrideStyle(f, {
        visible: cat === "すべて" || f.getProperty("category") === cat
      }));
    }

    function updateHistory(id) {
      let history = JSON.parse(localStorage.getItem("visitedPlaces") || "[]");
      history = history.filter(x => x !== id);
      history.unshift(id);
      localStorage.setItem("visitedPlaces", JSON.stringify(history));
    }

    function orderByHistory(features) {
      const history = JSON.parse(localStorage.getItem("visitedPlaces") || "[]");
      return [...features].sort((a, b) => {
        const ia = history.indexOf(a.getProperty("storeid"));
        const ib = history.indexOf(b.getProperty("storeid"));
        if (ia === -1 && ib === -1) return 0;
        if (ia === -1) return 1;
        if (ib === -1) return -1;
        return ia - ib;
      });
    }

    function locate() {
      if (!navigator.geolocation) return alert("位置情報が取得できません。");
      navigator.geolocation.getCurrentPosition(pos => {
        userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        new google.maps.Marker({
          position: userPos, map, title: "現在地",
          icon: { url: "https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png", scaledSize: new google.maps.Size(40, 40) }
        });
        map.setCenter(userPos);
        renderList(orderByHistory(allFeatures));
      });
    }

    loader.load().then(() => {
      map = new google.maps.Map(document.getElementById("map"), {
        mapId: "1df09633b5c319c7",
        center: DEFAULT_CENTER,
        zoom: 12,
      });
      infoWindow = new google.maps.InfoWindow();

      map.data.loadGeoJson("stores.json", { idPropertyName: "storeid" }, (features) => {
        allFeatures = features;
        const cats = [...new Set(features.map(f => f.getProperty("category")))];
        renderFilters(cats);
        map.data.setStyle(f => ({
          icon: {
            url: `img/icon_${f.getProperty("category")}.png`,
            scaledSize: new google.maps.Size(32, 32)
          }
        }));
        renderList(orderByHistory(features));
      });

      map.data.addListener("click", e => showInfo(e.feature));

      locate();
    });

    locBtn.addEventListener("click", locate);
    locBtnMobile.addEventListener("click", locate);
  </script>
</body>
</html>
