<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="description" content="お出かけ先一覧">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>お出かけ先一覧（改良版）</title>

  <style>
    :root {
      --sidebar-width: 320px;
      --panel-height: 260px;
      --accent: #4285F4;
      --muted: #666;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    #app {
      display: flex;
      height: 100%;
      width: 100%;
    }
    #sidebar {
      width: var(--sidebar-width);
      background: #fff;
      border-right: 1px solid #eee;
      padding: 12px;
      overflow: auto;
      display: none;
    }
    #map {
      flex: 1;
      height: 100%;
    }

    /* 下部パネル */
    #bottomPanel {
      display: none;
      position: absolute;
      left: 12px;
      right: 12px;
      bottom: 12px;
      height: var(--panel-height);
      background: rgba(255,255,255,0.98);
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
    }
    #bottomPanel.minimized {
      transform: translateY(calc(100% - 40px));
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
    }
    .btn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn.ghost {
      background: transparent;
      color: var(--accent);
      border: 1px solid rgba(66,133,244,0.3);
    }

    #list, #listMobile {
      overflow: auto;
      padding: 8px;
    }

    .list-item {
      display: flex;
      gap: 10px;
      align-items: center;
      border: 1px solid #eee;
      border-radius: 8px;
      margin-bottom: 8px;
      padding: 8px;
      cursor: pointer;
      background: #fff;
    }
    .list-item:hover { background: #f3f8ff; }
    .list-item img { width: 48px; height: 48px; object-fit: cover; border-radius: 6px; }
    .meta { flex: 1; }
    .meta h4 { margin: 0 0 4px 0; font-size: 15px; }
    .meta p { margin: 0; font-size: 13px; color: var(--muted); }
    .distance { font-weight: 600; color: var(--accent); font-size: 13px; white-space: nowrap; }

    @media (min-width: 900px) {
      #sidebar { display: block; }
      #bottomPanel { display: none; }
    }
    @media (max-width: 899px) {
      #sidebar { display: none; }
      #bottomPanel { display: flex; }
    }
  </style>
</head>

<body>
  <div id="app">
    <aside id="sidebar">
      <div class="toolbar">
        <h3>お出かけ先一覧</h3>
        <button id="locBtn" class="btn ghost">現在地</button>
      </div>
      <div id="list"></div>
    </aside>

    <div id="map"></div>

    <!-- モバイル用下部パネル -->
    <div id="bottomPanel">
      <div class="toolbar">
        <h3 style="margin:0;">お出かけ先</h3>
        <div style="display:flex; gap:6px;">
          <button id="locBtnMobile" class="btn ghost">現在地</button>
          <button id="togglePanel" class="btn">↕ 最小化</button>
        </div>
      </div>
      <div id="listMobile"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@googlemaps/js-api-loader@1.16.6/dist/index.umd.min.js"></script>

  <script>
    const API_KEY = "AIzaSyAOt_zaWcDh2x8yNprbwL2qvnRjzOrPaq0";
    const DEFAULT_CENTER = { lat: 35.457, lng: 139.395 };

    const loader = new google.maps.plugins.loader.Loader({
      apiKey: API_KEY,
      version: "weekly"
    });

    let map, infoWindow, userPos = null;

    const listEl = document.getElementById("list");
    const listMobileEl = document.getElementById("listMobile");
    const bottomPanel = document.getElementById("bottomPanel");
    const togglePanel = document.getElementById("togglePanel");
    const locBtn = document.getElementById("locBtn");
    const locBtnMobile = document.getElementById("locBtnMobile");

    togglePanel.addEventListener("click", () => {
      bottomPanel.classList.toggle("minimized");
    });

    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = v => v * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function formatDistance(m) {
      if (isNaN(m)) return "";
      return m >= 1000 ? (m / 1000).toFixed(1) + " km" : Math.round(m) + " m";
    }

    function renderList(features) {
      const makeItem = (f, d) => {
        const cat = f.getProperty("category");
        const img = `img/icon_${cat}.png`;
        const name = f.getProperty("name");
        const desc = f.getProperty("description") || "";
        const el = document.createElement("div");
        el.className = "list-item";
        el.innerHTML = `
          <img src="${img}" alt="${cat}">
          <div class="meta"><h4>${name}</h4><p>${desc}</p></div>
          <div class="distance">${formatDistance(d)}</div>
        `;
        el.addEventListener("click", () => {
          const pos = f.getGeometry().get();
          map.panTo(pos);
          map.setZoom(Math.max(map.getZoom(), 14));
          infoWindow.setContent(buildInfoContent(f));
          infoWindow.setPosition(pos);
          infoWindow.open(map);
        });
        return el;
      };
      listEl.innerHTML = "";
      listMobileEl.innerHTML = "";
      features.forEach(f => {
        const pos = f.getGeometry().get();
        const d = userPos
          ? haversineDistance(userPos.lat, userPos.lng, pos.lat(), pos.lng())
          : haversineDistance(DEFAULT_CENTER.lat, DEFAULT_CENTER.lng, pos.lat(), pos.lng());
        listEl.appendChild(makeItem(f, d));
        listMobileEl.appendChild(makeItem(f, d));
      });
    }

    function buildInfoContent(f) {
      const cat = f.getProperty("category");
      const name = f.getProperty("name");
      const desc = f.getProperty("description");
      const hours = f.getProperty("hours");
      const closed = f.getProperty("closed");
      const main_site = f.getProperty("main_site");
      const sub_site = f.getProperty("sub_site");
      const ido = f.getProperty("ido");
      const keido = f.getProperty("keido");
      return `
        <img style="float:left; width:50px; margin:6px;" src="img/logo_${cat}.png">
        <div style="margin-left:60px;">
          <h2 style="font-size:16px; margin:0;">${name}</h2>
          <p style="font-size:13px;">${desc}</p>
          <p style="font-size:13px;">
            <b>Open:</b> ${hours}<br/>
            <b>Closed:</b> ${closed}<br/>
            <a href="${main_site}" target="_blank"><b>公式サイト</b></a><br/>
            <a href="${sub_site}" target="_blank"><b>参考サイト</b></a><br/>
            <a href="yjcarnavi://navi/select?lat=${ido}&lon=${keido}&name=${name}"><b>車で向かう（Yahooカーナビ）</b></a><br/>
            <a href="https://www.google.com/maps/dir/?api=1&destination=${ido},${keido}&travelmode=walking" target="_blank"><b>徒歩で向かう（GoogleMap）</b></a>
          </p>
        </div>`;
    }

    function locateAndCenter() {
      if (!navigator.geolocation) {
        alert("位置情報がサポートされていません。");
        return;
      }
      navigator.geolocation.getCurrentPosition(pos => {
        userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        new google.maps.Marker({
          position: userPos,
          map,
          title: "現在地",
          icon: {
            url: "https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png",
            scaledSize: new google.maps.Size(40, 40)
          }
        });
        map.setCenter(userPos);
        map.setZoom(Math.max(map.getZoom(), 13));
      }, err => {
        console.warn("現在地エラー:", err);
        alert("現在地が取得できませんでした。");
      });
    }

    loader.load().then(() => {
      map = new google.maps.Map(document.getElementById("map"), {
        mapId: "1df09633b5c319c7",
        center: DEFAULT_CENTER,
        zoom: 12,
      });
      infoWindow = new google.maps.InfoWindow();

      map.data.loadGeoJson("stores.json", { idPropertyName: "storeid" }, (features) => {
        map.data.setStyle(f => ({
          icon: {
            url: `img/icon_${f.getProperty("category")}.png`,
            scaledSize: new google.maps.Size(32, 32)
          }
        }));
        renderList(features);
      });

      map.data.addListener("click", e => {
        const pos = e.feature.getGeometry().get();
        infoWindow.setContent(buildInfoContent(e.feature));
        infoWindow.setPosition(pos);
        infoWindow.open(map);
      });

      locateAndCenter();
    });

    locBtn.addEventListener("click", locateAndCenter);
    locBtnMobile.addEventListener("click", locateAndCenter);
  </script>
</body>
</html>
